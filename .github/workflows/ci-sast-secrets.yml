name: Security - SAST & Secrets

on:
  workflow_dispatch:
  push:
    paths:
      - "**/*.py"
      - "security/**"
      - ".github/workflows/ci-sast-secrets.yml"
  pull_request:
    paths:
      - "**/*.py"
      - "security/**"
      - ".github/workflows/ci-sast-secrets.yml"

permissions:
  contents: read

concurrency:
  group: sast-secrets-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sast-and-secrets:
    name: Run Semgrep and Gitleaks
    runs-on: ubuntu-latest
    env:
      SEMGREP_IMAGE: returntocorp/semgrep:1.67.0
      GITLEAKS_IMAGE: zricethezav/gitleaks:v8.18.4
    steps:
      - uses: actions/checkout@v4

      - name: Prepare evidence directory
        run: mkdir -p EVIDENCE/P10

      - name: Run Semgrep (p/ci + project rules)
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/src" \
            -w /src \
            "${{ env.SEMGREP_IMAGE }}" \
            semgrep scan \
            --config p/ci \
            --config ./security/semgrep/rules.yml \
            --metrics=off \
            --timeout 300 \
            --sarif --output EVIDENCE/P10/semgrep.sarif || true

      - name: Run Gitleaks scan
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/repo" \
            -w /repo \
            "${{ env.GITLEAKS_IMAGE }}" \
            detect \
            --source=/repo \
            --no-git \
            --config=/repo/security/.gitleaks.toml \
            --report-format=json \
            --report-path=/repo/EVIDENCE/P10/gitleaks.json \
            --exit-code=0

      - name: Build SAST & secrets summary
        run: |
          python - <<'PY'
          import json
          from collections import Counter
          from pathlib import Path

          evidence_dir = Path("EVIDENCE/P10")
          semgrep_path = evidence_dir / "semgrep.sarif"
          gitleaks_path = evidence_dir / "gitleaks.json"
          summary_path = evidence_dir / "sast_summary.md"
          evidence_dir.mkdir(parents=True, exist_ok=True)

          lines = ["# P10 SAST & secrets summary", ""]

          if semgrep_path.exists():
              semgrep_data = json.loads(semgrep_path.read_text() or "{}")
              results = next(iter(semgrep_data.get("runs", [])), {}).get("results", [])
              levels = Counter()
              for result in results:
                  level = (result.get("level") or "").lower()
                  if level:
                      levels[level] += 1
              if levels:
                  lines.append("Semgrep findings by level:")
                  for key in ("error", "warning", "note"):
                      if key in levels:
                          lines.append(f"- {key.title()}: {levels[key]}")
              else:
                  lines.append("Semgrep reported no findings.")
          else:
              lines.append("Semgrep report not found.")

          if gitleaks_path.exists():
              gitleaks_data = json.loads(gitleaks_path.read_text() or "[]")
              leaks = []
              if isinstance(gitleaks_data, list):
                  leaks = gitleaks_data
              elif isinstance(gitleaks_data, dict):
                  leaks = gitleaks_data.get("leaks") or gitleaks_data.get("Leaks") or []
              lines.append("")
              if leaks:
                  lines.append(f"Gitleaks detected {len(leaks)} potential secret(s).")
              else:
                  lines.append("Gitleaks reported no secrets.")
          else:
              lines.extend(["", "Gitleaks report not found."])

          summary_path.write_text("\n".join(lines))
          PY

      - name: Upload SAST & secrets artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sast-secrets-artifacts
          path: |
            EVIDENCE/P10/semgrep.sarif
            EVIDENCE/P10/gitleaks.json
            EVIDENCE/P10/sast_summary.md
          if-no-files-found: error
