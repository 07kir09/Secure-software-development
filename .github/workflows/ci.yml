name: Secure CI

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

env:
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  PIP_NO_PYTHON_VERSION_WARNING: "1"
  PYTHONDONTWRITEBYTECODE: "1"

permissions:
  contents: read
  packages: write

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  qa-matrix:
    name: QA (py${{ matrix.python-version }} / ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        python-version: ["3.11", "3.12"]
    env:
      APP_API_TOKEN: ${{ secrets.APP_API_TOKEN || 'ci-fallback-token' }}
      DATABASE_URL: ${{ vars.CI_DATABASE_URL || 'sqlite:///:memory:' }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip
          cache-dependency-path: |
            requirements.txt
            requirements-dev.txt
            pyproject.toml

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt -r requirements-dev.txt

      - name: Ruff
        run: ruff check .

      - name: Black
        run: black --check .

      - name: isort
        run: isort --profile black --check-only .

      - name: Tests
        run: pytest -q

  quality-reports:
    name: Coverage & reports
    needs: qa-matrix
    runs-on: ubuntu-latest
    env:
      APP_API_TOKEN: ${{ secrets.APP_API_TOKEN || 'ci-fallback-token' }}
      DATABASE_URL: ${{ vars.CI_DATABASE_URL || 'sqlite:///:memory:' }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: |
            requirements.txt
            requirements-dev.txt
            pyproject.toml

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt -r requirements-dev.txt

      - name: Run pytest with coverage
        run: |
          mkdir -p reports
          pytest --junitxml=reports/pytest.xml \
            --cov=app \
            --cov-report=xml:reports/coverage.xml \
            --cov-report=term \
            --cov-report=html:reports/htmlcov

      - name: Upload reports
        uses: actions/upload-artifact@v4
        with:
          name: test-artifacts
          if-no-files-found: error
          retention-days: 14
          path: |
            reports/pytest.xml
            reports/coverage.xml
            reports/htmlcov

  python-package:
    name: Build wheel
    needs: qa-matrix
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: |
            requirements.txt
            requirements-dev.txt
            pyproject.toml

      - name: Install build backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt -r requirements-dev.txt

      - name: Build distributions
        run: python -m build

      - name: Upload wheel
        uses: actions/upload-artifact@v4
        with:
          name: python-package
          if-no-files-found: error
          path: dist/*

  docker-image:
    name: Publish container
    needs: [python-package]
    runs-on: ubuntu-latest
    outputs:
      image: ${{ steps.primary-tag.outputs.value }}
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=sha
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Capture primary tag
        id: primary-tag
        run: |
          echo "value=$(echo "${TAGS}" | head -n1)" >> "$GITHUB_OUTPUT"
        env:
          TAGS: ${{ steps.meta.outputs.tags }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          target: runtime
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  staging-smoke:
    name: Staging smoke test
    needs: docker-image
    runs-on: ubuntu-latest
    env:
      APP_IMAGE: ${{ needs.docker-image.outputs.image }}
      APP_API_TOKEN: ${{ secrets.APP_API_TOKEN || 'ci-fallback-token' }}
      DATABASE_URL: ${{ vars.CI_DATABASE_URL || 'sqlite:///:memory:' }}
      CACHE_URL: ${{ vars.CI_CACHE_URL || 'redis://cache:6379/0' }}
      BROKER_URL: ${{ vars.CI_BROKER_URL || 'amqp://app:app@queue:5672/app' }}
    steps:
      - uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull release image
        run: docker pull "${APP_IMAGE}"

      - name: Load AppArmor profile
        run: sudo apparmor_parser -r deploy/security/apparmor/secdev-course-app

      - name: Launch preview stack
        run: docker compose up -d

      - name: Wait for /health
        run: |
          for attempt in {1..20}; do
            if curl -fsS http://127.0.0.1:8000/health | grep -q '"status": *"ok"'; then
              exit 0
            fi
            sleep 5
          done
          docker compose logs app
          exit 1

      - name: Tear down preview stack
        if: always()
        run: docker compose down -v
